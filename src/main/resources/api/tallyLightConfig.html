<!DOCTYPE html>
<!--
Created by: Samuel-Anton Jansen
-->
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            box-sizing: border-box;
            font-size: 12pt;
            color: #5b5a5a;
            font-family: "Arial Black", Gadget, sans-serif;
        }

        html, body {
            height: 100%;
            padding: 0;
            margin: 0;
            background-color: #f1f1f1;
        }

        #wrapper {
            padding: 10px;
            margin: 0 auto;
            height: 100%;
            max-width: 700px;
        }

        .template {
            display: none;
        }

        table {
            margin-bottom: 15px;
            border-collapse: collapse;
            width: 100%;
        }

        table th {
            padding: 6px 14px 12px;
        }

        table tr {
            margin: 5px 0;
        }

        table tbody tr:hover td {
            border: 0 solid #ddd;
            border-width: 1px 0;
        }

        table tbody td:last-of-type {
            text-align: center;
        }

        select {
            padding: 4px 9px;
        }

        button {
            padding: 5px 25px;
        }

        input[type=text] {
            padding: 10px;
            border-width: 0;
            background: none;
        }

        section {
            margin-bottom: 45px;
        }

        hr {
            border: none;
            border-bottom: 4px double #dcdcdc;
            width: 90%;
        }

        h1 {
            font-size: 29pt;
            text-align: center;
            text-transform: uppercase;
            text-shadow: 0px 1px 2px #bebebe;
            color: rgb(241, 241, 241);
            border-bottom: 1px solid #ddd;
            width: 80%;
            margin: 20px auto;
            padding: 13px 0;
        }

        .action-buttons-div {
            text-align: center;
        }

        #tally-list .tally-input td:first-of-type {
            border-width: 0;
        }

        .filter-name {
            display: inline-block;
            padding: 13px 7px;
        }
    </style>
    <style>
        /* NOTIFICATIONS */
        #notifications {
            position: absolute;
            top: 0;
            right: 0;
            margin: 20px;
            transition: all 1s;
        }

        .notification {
            background-color: #e7daff;
            padding: 15px 21px;
            border-radius: 10px;
            border: 1px solid #cbbfe1;
            margin-bottom: 13px;
            transition: all 500ms;
            max-width: 400px;
            color: #8b7fa2;
            box-shadow: 2px 3px 4px -2px #00000029;
        }

        .notification-error {
            background-color: #ffdae3;
            color: #a27f87;
        }

        .notification-error .notification-title, .notification-error .notification-close {
            color: #daa2b7;
        }

        .notification-success {
            background-color: #e2ffda;
            color: #88a27f;
        }

        .notification-success .notification-title, .notification-success .notification-close {
            color: #a2daa8;
        }

        .notification-title {
            font-weight: bold;
            font-size: 11pt;
            color: #b6a2da;
            padding: 0 0px 4px 0;
        }

        .notification-message {
            color: inherit;
        }

        .notification-close {
            color: #b6a2da;
            text-decoration: none;
            font-size: 9pt;
            float: right;
        }

        .notification-close:hover {
            text-decoration: underline;
        }
    </style>
</head>
<body>
<div id="wrapper">
    <section id="tally-config">
        <h1>Tally Lights</h1>

        <table id="tally-list">
            <thead>
            <tr>
                <th>Source</th>
                <th>Tally Host</th>
                <th>Remove?</th>
            </tr>
            </thead>

            <tbody>
            <!-- Input template -->
            <tr class="tally-input template" id="tally-input-template">
                <td>
                    <label>
                        <select name="source"
                                required>
                            <option>Camera 1</option>
                        </select>
                    </label>
                </td>

                <td>
                    <label>
                        <input type="text"
                               name="host"
                               value=""
                               placeholder="192.168.178.1"
                               pattern="((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\.|$)){4}"/>
                    </label>
                </td>

                <td>
                    <label>
                        <input type="checkbox"
                               name="remove"/>
                    </label>
                </td>
            </tr>
            </tbody>
        </table>

        <div class="action-buttons-div">
            <button id="add-tally">Add new camera/source</button>
            <button id="save-tallies">Save all</button>
        </div>
    </section>

    <section id="filter-config">
        <h1>Filters</h1>

        <table id="filter-list">
            <thead>
            <tr>
                <th>Filter</th>
                <th>Enabled</th>
            </tr>
            </thead>

            <tbody>
            <!-- Input template -->
            <tr class="filter-edit template" id="filter-edit-template">
                <td>
                    <span class="filter-name" data-classname=""></span>
                </td>

                <td>
                    <label>
                        <input type="checkbox"
                               name="enabled"/>
                    </label>
                </td>
            </tr>
            </tbody>
        </table>

        <div class="action-buttons-div">
            <button id="save-filters">Save changes</button>
        </div>
    </section>
</div>

<div id="notifications">
    <div class="notification template"
         id="notification-template">
        <a href="javascript:void(0);" class="notification-close">close</a>
        <div class="notification-title"></div>
        <div class="notification-message"></div>
    </div>
</div>

<script>
    /* CLASSES */
    class TallyLight {
        constructor(sourceName, host) {
            this.cameraSourceName = sourceName;
            this.host = host;
        }
    }

    class Filter {
        constructor(className, enabled) {
            this.className = className;
            this.enabled = enabled;
        }
    }

    class Notification {
        constructor(title, message, type) {
            this.title = title;
            this.message = message;
            this.type = type;
        }

        static INFO = "info";
        static SUCCESS = "success";
        static ERROR = "error";
    }
</script>
<script>
    /* NOTIFICATIONS */
    const notificationsParent = document.querySelector("#notifications");
    const notificationTemplate = document.querySelector("#notification-template");
    const notificationDuration = 10_000;

    const getTransitionDurationForElement = (notificationElement) => {
        const transitionDurationString = window.getComputedStyle(notificationElement).transitionDuration;
        return transitionDurationString.substring(0, transitionDurationString.length - 1) * 1000;
    }

    const removeNotification = (notificationElement) => {
        console.debug("Removing notification:", notificationElement);
        notificationElement.style.opacity = "0";

        const transitionDuration = getTransitionDurationForElement(notificationElement);
        window.setTimeout(() => notificationElement.remove(), transitionDuration);
    }

    const addNotification = (notification) => {
        console.info("Adding notification: ", notification);
        const template = notificationTemplate.cloneNode(true);
        template.removeAttribute("id");
        template.classList.remove("template");

        if (notification instanceof Notification) {
            template.querySelector(".notification-title").innerHTML = notification.title;
            template.querySelector(".notification-message").innerHTML = notification.message;
            template.classList.add("notification-" + notification.type);
        }

        template.querySelector(".notification-close")
            .addEventListener("click", () => removeNotification(template));

        notificationsParent.appendChild(template);

        window.setTimeout(removeNotification, notificationDuration, template);
    }
</script>
<script>
    /* API */
    const get = (url) => fetch(url, {
        method: "GET"
    });

    const post = (url, data = "") => fetch(url, {
        method: "POST",
        body: JSON.stringify(data)
    });

    const throwErrorsIfNotOk = (response) => {
        if (response.status === 404) {
            throw Error(`Could not connect to server (${response.status})`);
        } else if(!response.ok) {
            throw Error(`Request failed: ${response.status} ${response.statusText}`);
        }
        return response;
    }

    const apiBaseUrl = window.location.origin + "/api/v1";
    const api = {
        tallyLight: {
            list: {
                get: () => get(apiBaseUrl + "/tallylight/list"),
                add: (data) => post(apiBaseUrl + "/tallylight/add", data),
                addAll: (data) => post(apiBaseUrl + "/tallylight/addAll", data),
                remove: (data) => post(apiBaseUrl + "/tallylight/remove", data),
                clear: () => post(apiBaseUrl + "/tallylight/removeAll")
            },
            sources: {
                get: () => get(apiBaseUrl + "/tallylight/sources")
            },
            filters: {
                get: () => get(apiBaseUrl + "/tallylight/filters/list"),
                saveAll: (data) => post(apiBaseUrl + "/tallylight/filters/saveAll", data)
            },
        }
    };
</script>
<script>
    /* TALLY CONFIG */
    const tallyList = document.querySelector("#tally-list tbody");
    const tallyInputTemplate = document.getElementById("tally-input-template");
    const addTallyButton = document.getElementById("add-tally");
    const saveTalliesButton = document.getElementById("save-tallies");

    const updateList = () => {
        console.log("Updating Tally Light list");

        return api.tallyLight.list.get()
            .then(throwErrorsIfNotOk)
            .then(r => r.json())
            .then(data => {
                tallyList.innerHTML = "";
                data.data
                    .map((tally) => new TallyLight(tally.cameraSourceName, tally.host))
                    .sort((a, b) => a.cameraSourceName.toUpperCase() > b.cameraSourceName.toUpperCase())    // Ignore case
                    .forEach(addTally);
            })
            .catch(error => {
                console.error('Error getting Tally Lights', error);
                addNotification(new Notification("Error getting Tally Lights", error.message, Notification.ERROR));
            });
    }

    const updateSources = () => {
        console.log("Updating scene sources");
        return api.tallyLight.sources.get()
            .then(throwErrorsIfNotOk)
            .then(r => r.json())
            .then(data => {
                const options = data.data
                    .map((source) => `<option>${source}</option>`)
                    .join("");

                document.querySelectorAll("[name=source]").forEach((select) => {
                    const selectedValue = select.value;
                    select.innerHTML = options;
                    select.value = selectedValue;
                });
            })
            .catch(error => {
                console.error('Error getting sources', error);
                addNotification(new Notification("Error getting sources", error.message, Notification.ERROR));
            });
    }

    const addTally = (tallyLight) => {
        const newInput = tallyInputTemplate.cloneNode(true);
        newInput.removeAttribute("id");
        newInput.classList.remove("template");

        if (tallyLight instanceof TallyLight) {
            newInput.querySelector("[name=source]").value = tallyLight.cameraSourceName;
            newInput.querySelector("[name=host]").value = tallyLight.host;
        }

        tallyList.appendChild(newInput);
    }

    const saveTallies = () => {
        console.log("Saving Tally Lights");
        const tallyInputs = Array.from(document.querySelectorAll(".tally-input:not(.template)"));

        const tallyLights = tallyInputs.map((input) => {
            const sourceName = input.querySelector("[name=source]").value;
            const host = input.querySelector("[name=host]").value;
            const remove = input.querySelector("[name=remove]").checked;

            const tallyLight = new TallyLight(sourceName, host);

            if (remove) {
                console.log("Removing Tally Light", tallyLight);
                return null
            }

            return tallyLight
        })
            .filter((item) => item != null)

        return api.tallyLight.list.addAll(tallyLights)
            .then(throwErrorsIfNotOk)
            .then(r => r.json())
            .then(() => {
                addNotification(new Notification("Tally Lights saved!", "", Notification.SUCCESS));
                updateList();
            })
            .catch(error => {
                console.error('Error saving tally lights', tallyLights, error)
                addNotification(new Notification("Error saving Tally Lights", error.message, Notification.ERROR));
            });
    }

    addTallyButton.addEventListener("click", addTally);
    saveTalliesButton.addEventListener("click", saveTallies);

    updateSources().then(() => {
        updateList();
    })
</script>
<script>
    /* FILTER CONFIG */
    const filterList = document.querySelector("#filter-list tbody");
    const filterEditTemplate = document.getElementById("filter-edit-template");
    const saveFiltersButton = document.getElementById("save-filters");

    const updateFilterList = () => {
        console.log("Updating filter list");

        return api.tallyLight.filters.get()
            .then(throwErrorsIfNotOk)
            .then(r => r.json())
            .then(data => {
                filterList.innerHTML = "";
                data.data
                    .map((filter) => new Filter(filter.className, filter.enabled))
                    .sort((a, b) => a.className.toUpperCase() > b.className.toUpperCase())    // Ignore case
                    .forEach(addFilter);
            })
            .catch(error => {
                console.error('Error getting filters', error);
                addNotification(new Notification("Error getting filters", error.message, Notification.ERROR));
            });
    }

    const addFilter = (filter) => {
        const newInput = filterEditTemplate.cloneNode(true);
        newInput.removeAttribute("id");
        newInput.classList.remove("template");

        if (filter instanceof Filter) {
            newInput.querySelector(".filter-name").dataset.classname = filter.className;
            newInput.querySelector(".filter-name").innerHTML = filter.className;
            newInput.querySelector("[name=enabled]").checked = filter.enabled;
        }

        filterList.appendChild(newInput);
    }

    const saveFilters = () => {
        console.log("Saving filters");
        const filterEdits = Array.from(document.querySelectorAll(".filter-edit:not(.template)"));

        const filters = filterEdits.map((element) => {
            const className = element.querySelector(".filter-name").dataset.classname;
            const enabled = element.querySelector("[name=enabled]").checked;

            return new Filter(className, enabled)
        })
            .filter((item) => item != null)

        return api.tallyLight.filters.saveAll(filters)
            .then(throwErrorsIfNotOk)
            .then(r => r.json())
            .then(() => {
                addNotification(new Notification("Filters saved!", "", Notification.SUCCESS));
                updateFilterList();
            })
            .catch(error => {
                console.error('Error saving filters', filters, error);
                addNotification(new Notification("Error saving filters", error.message, Notification.ERROR));
            });
    }

    saveFiltersButton.addEventListener("click", saveFilters);

    updateFilterList();
</script>
</body>
</html>