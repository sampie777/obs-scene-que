<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <style>
        * {
            box-sizing: border-box;
            font-size: 12pt;
            color: #5b5a5a;
            font-family: "Arial Black", Gadget, sans-serif;
        }

        html, body {
            height: 100%;
            padding: 0;
            margin: 0;
            background-color: #f1f1f1;
        }

        #wrapper {
            padding: 10px;
            margin: 0 auto;
            height: 100%;
            max-width: 700px;
        }

        .template {
            display: none;
        }

        #tally-list {
            margin-bottom: 15px;
            border-collapse: collapse;
        }

        #tally-list th {
            padding: 6px 14px 12px;
        }

        #tally-list .tally-input {
            margin: 5px 0;
        }

        #tally-list .tally-input:hover td{
            border: 1px solid #bbb;
            border-width: 1px 0;
        }

        #tally-list .tally-input td:first-of-type{
            border-width: 0;
        }

        #tally-list .tally-input td:last-of-type{
            text-align: center;
        }

        #tally-list .tally-input select {
            padding: 4px 9px;
        }

        #tally-list .tally-input input[type=text] {
            padding: 10px;
            border-width: 0;
            background: none;
        }

        button {
            padding: 5px 25px;
        }
    </style>
</head>
<body>
<div id="wrapper">
    <table id="tally-list">
        <thead>
        <tr>
            <th>Source</th>
            <th>Tally Host</th>
            <th>Remove?</th>
        </tr>
        </thead>

        <tbody>
        <!-- Input template -->
        <tr class="tally-input template" id="tally-input-template">
            <td>
                <label>
                    <select name="source"
                            required>
                        <option>Camera 1</option>
                    </select>
                </label>
            </td>

            <td>
                <label>
                    <input type="text"
                           name="host"
                           value=""
                           placeholder="192.168.178.1"
                           pattern="((25[0-5]|2[0-4][0-9]|[01]?[0-9][0-9]?)(\.|$)){4}"/>
                </label>
            </td>

            <td>
                <label>
                    <input type="checkbox"
                           name="remove"/>
                </label>
            </td>
        </tr>
        </tbody>
    </table>

    <div>
        <button id="add-tally">Add new camera/source</button>
        <button id="save-tallies">Save all</button>
    </div>
</div>

<script>
    /* API */
    const get = (url) => fetch(url, {
        method: "GET"
    });

    const post = (url, data = "") => fetch(url, {
        method: "POST",
        body: JSON.stringify(data)
    });

    const apiBaseUrl = window.location.origin + "/api/v1";
    const api = {
        tallyLight: {
            list: {
                get: () => get(apiBaseUrl + "/tallylight/list"),
                add: (data) => post(apiBaseUrl + "/tallylight/add", data),
                addAll: (data) => post(apiBaseUrl + "/tallylight/addAll", data),
                remove: (data) => post(apiBaseUrl + "/tallylight/remove", data),
                clear: () => post(apiBaseUrl + "/tallylight/removeAll")
            },
            sources: {
                get: () => get(apiBaseUrl + "/tallylight/sources")
            },
            filters: {
                get: () => get(apiBaseUrl + "/tallylight/filters")
            },
        }
    };
</script>
<script>
    /* CLASSES */
    class TallyLight {
        constructor(sourceName, host) {
            this.cameraSourceName = sourceName;
            this.host = host;
        }

    }
</script>
<script>
    /* PAGE */
    const tallyList = document.querySelector("#tally-list tbody");
    const tallyInputTemplate = document.getElementById("tally-input-template");
    const addTallyButton = document.getElementById("add-tally");
    const saveTalliesButton = document.getElementById("save-tallies");

    const updateList = () => {
        console.log("Updating Tally Light list");

        return api.tallyLight.list.get()
            .then(r => r.json())
            .then(data => {
                tallyList.innerHTML = "";
                data.data
                    .map((tally) => new TallyLight(tally.cameraSourceName, tally.host))
                    .sort((a, b) => a.cameraSourceName.toUpperCase() > b.cameraSourceName.toUpperCase())    // Ignore case
                    .forEach(addTally);
            })
            .catch(error => console.error('Error getting sources', error));
    }

    const updateSources = () => {
        console.log("Updating scene sources");
        return api.tallyLight.sources.get()
            .then(r => r.json())
            .then(data => {
                const options = data.data
                    .map((source) => `<option>${source}</option>`)
                    .join("");

                document.querySelectorAll("[name=source]").forEach((select) => {
                    const selectedValue = select.value;
                    select.innerHTML = options;
                    select.value = selectedValue;
                });
            })
            .catch(error => console.error('Error getting sources', error));
    }

    const addTally = (tallyLight) => {
        const newInput = tallyInputTemplate.cloneNode(true);
        newInput.removeAttribute("id");
        newInput.classList.remove("template");

        if (tallyLight instanceof TallyLight) {
            newInput.querySelector("[name=source]").value = tallyLight.cameraSourceName;
            newInput.querySelector("[name=host]").value = tallyLight.host;
        }

        tallyList.appendChild(newInput);
    }

    const saveTallies = () => {
        console.log("Saving Tally Lights");
        const tallyInputs = Array.from(document.querySelectorAll(".tally-input:not(.template)"));

        const tallyLights = tallyInputs.map((input) => {
            const sourceName = input.querySelector("[name=source]").value;
            const host = input.querySelector("[name=host]").value;
            const remove = input.querySelector("[name=remove]").checked;

            const tallyLight = new TallyLight(sourceName, host);

            if (remove) {
                console.log("Removing Tally Light", tallyLight);
                return null
            }

            return tallyLight
        })
            .filter((item) => item != null)

        return api.tallyLight.list.addAll(tallyLights)
            .then(r => r.json())
            .then(() => {
                updateList();
            })
            .catch(error => console.error('Error adding tally lights', tallyLights, error));
    }

    addTallyButton.addEventListener("click", addTally);
    saveTalliesButton.addEventListener("click", saveTallies);

    updateSources().then(() => {
        updateList();
    })
</script>
</body>
</html>